{"version":3,"sources":["webpack:///./src/components/notes/editor.jsx"],"names":["jsonTransformer","JSONTransformer","withCollab","collabUrl","allowPublicCollab","Form","props","readOnlyTitle","autoSave","firstNote","useMemo","title","note","content","_id","defaultTitleValue","defaultTitle","userId","Math","floor","random","sessionId","docId","collabProvider","useNativePlugin","provider","Promise","resolve","CollabProvider","ServiceClient","url","inviteToEditHandler","undefined","isInviteToEditButtonSelected","serverNote","useRef","useEffect","current","_rev","currentNote","save","debounce","saveDocument","leading","trailing","onTitleChange","useCallback","e","newTitle","target","value","trim","length","console","log","window","setTimeout","onContentChange","editorView","state","JSON","stringify","encode","doc","collabProps","collabEdit","changeContentProps","onChange","changeTitleProps","readOnly","border","fontWeight","fontSize","marginBottom","position","display","flexDirection","overflow","flexGrow","editorConfig","MutatedForm","withMutations","FormOrSpinner","notes","data","fetchStatus","isLoading","couchNote","fakeNote","id","history","push","showSpinner","left","Link","height","match","params","query","client","find","doctype","where","Component","queryConnect","as","withRouter"],"mappings":"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","file":"app.96a20d0ea2e2f603507e.hot-update.js","sourcesContent":["import React, { useState, useCallback, useRef, useEffect, useMemo } from 'react'\n\nimport { Editor } from '@atlaskit/editor-core'\nimport { JSONTransformer } from '@atlaskit/editor-json-transformer'\n\nimport { withRouter } from 'react-router-dom'\nimport { Link } from 'react-router-dom'\n\nimport debounce from 'lodash.debounce'\n\nimport Spinner from 'cozy-ui/react/Spinner'\nimport Input from 'cozy-ui/react/Input'\nimport Button from 'cozy-ui/react/Button'\n\nimport { queryConnect, withMutations } from 'cozy-client'\n\nimport doctype from './doctype'\nimport { defaultTitle } from './utils'\n//import { collabEditProvider } from './collab_provider'\nimport CollabProvider from '../../lib/collab/provider'\nimport ServiceClient from '../../lib/collab/client'\nimport editorConfig from './editor_config'\n\nimport HeaderMenu from '../header_menu'\n\nconst jsonTransformer = new JSONTransformer()\n\nconst withCollab = true\nconst collabUrl = 'https://poc-collab.cozycloud.cc/'\nconst allowPublicCollab = true\n\nconst Form = props => {\n  const {readOnlyTitle, autoSave} = props\n\n  // first note received in the props, to avoid useless changes in defaultValue\n  const firstNote = useMemo(\n    () => ({ title: props.note.title, content: props.note.content }),\n    [props.note._id]\n  )\n  // same with the title placeholder\n  const defaultTitleValue = useMemo(\n    () => props.note.defaultTitle || defaultTitle(props.note),\n    [props.note._id]\n  )\n  // then with the collabProvider to avoid an init at each render\n  const userId  = useMemo(\n    () => `user${Math.floor(Math.random() * 1000)}`,\n    []\n  )\n  const sessionId = userId\n  const docId = props.note._id\n  const collabProvider = useMemo(\n    () => ({\n      useNativePlugin: true,\n      provider: Promise.resolve(\n        new CollabProvider(\n          { docId, userId, sessionId },\n          new ServiceClient({ url: collabUrl, docId, userId, sessionId })\n        )\n      ),\n      inviteToEditHandler: () => undefined,\n      isInviteToEditButtonSelected: true,\n      userId\n    }),\n    [props.note._id, userId]\n  )\n  // get the previous note in a ref to be able to fetch the last _rev\n  // when sending the update to the couch server\n  const serverNote = useRef(props.note)\n  useEffect(\n    () => {\n      serverNote.current = props.note\n    },\n    [props.note._rev]\n  )\n\n  // we do note use the state in our callbacks to\n  // avoid a capture of an old {note} variable\n  const currentNote = useRef(\n    {\n      title: props.note.title,\n      content: props.note.content\n    }\n  )\n\n  // do not save more often than 5000ms\n  // it will generate conflict with _rev of couchdb\n  // and will overload couch database with useless versions\n  const save = useMemo(\n    () =>\n      debounce(\n        () => props.saveDocument({ ...serverNote.current, ...currentNote.current }),\n        5000,\n        { leading: true, trailing: true }\n      ),\n    [props.note._id]\n  )\n\n  // fix callbacks\n  const onTitleChange = useCallback(\n    e => {\n      const newTitle = e.target.value\n      const title = newTitle && newTitle.trim().length > 0 ? newTitle : null\n      if (title != currentNote.current.title) {\n        console.log(\"save title\", title, \"with content\", currentNote.current.content)\n        currentNote.current = { ...currentNote.current, title }\n        window.setTimeout(() => save())\n      }\n    },\n    [props.note._id]\n  )\n\n  const onContentChange = useCallback(\n    editorView => {\n      console.log(editorView.state)\n      const content = JSON.stringify(\n        jsonTransformer.encode(editorView.state.doc),\n        null,\n        2\n      )\n      if (content != currentNote.current.content) {\n        console.log(\"save content\", content, \"with title\", currentNote.current.title)\n        currentNote.current = { ...currentNote.current, content }\n        window.setTimeout(() => save())\n      }\n    },\n    [props.note._id]\n  )\n\n  const collabProps = useMemo(\n    () => withCollab ? { collabEdit: collabProvider } : { },\n    [withCollab, props.note._id]\n  )\n\n  const changeContentProps = useMemo(\n    () => autoSave ? { onChange: onContentChange } : { },\n    [autoSave, props.note._id]\n  )\n\n  const changeTitleProps = useMemo(\n    () => autoSave ? { onChange: onTitleChange } : { readOnly: true },\n    [autoSave, props.note._id]\n  )\n\n\n  // then memoize the rendering, the rest is pureComponent\n  return useMemo(\n    () => (\n      <React.Fragment>\n        <Input\n          fullwidth={true}\n          defaultValue={firstNote.title}\n          {...changeTitleProps}\n          placeholder={defaultTitleValue}\n          style={{\n            border: 'none',\n            fontWeight: 'bold',\n            fontSize: '1.5rem',\n            marginBottom: '-1rem'\n          }}\n        />\n        <div\n          style={{\n            position: 'relative',\n            display: 'flex',\n            flexDirection: 'column',\n            overflow: 'hidden',\n            flexGrow: '1'\n          }}\n        >\n          <Editor\n            {...collabProps}\n            {...changeContentProps}\n            defaultValue={firstNote.content}\n            {...editorConfig}\n            appearance=\"full-page\"\n            placeholder=\"Que voulez-vous dire ?\"\n            shouldFocus={true}\n          />\n        </div>\n      </React.Fragment>\n    ),\n    [props.note._id]\n  )\n}\n\nconst MutatedForm = withMutations()(Form)\n\nconst FormOrSpinner = props => {\n  const {\n    notes: { data, fetchStatus }\n  } = props\n  const isLoading = fetchStatus === 'loading' || fetchStatus === 'pending'\n\n  const couchNote = data && data[0]\n  const fakeNote = useMemo(\n    () => {\n      if (allowPublicCollab && withCollab) {\n        return {\n          _id: props.id,\n          id: props.id,\n          defaultTitle: \"Note collaborative en édition publique\"\n        }\n      } else {\n        return undefined\n      }\n    },\n    [props.id, allowPublicCollab]\n  )\n\n  const note = couchNote || fakeNote\n\n  if (!isLoading && !note) {\n    window.setTimeout(() => props.history.push(`/`), 0)\n  }\n\n  const showSpinner = isLoading || !note\n\n  const left = (\n    <Button\n      icon=\"back\"\n      tag={Link}\n      to=\"/\"\n      className=\"sto-app-back\"\n      label=\"Retour à la liste\"\n      subtle\n    />\n  )\n\n  return (\n    <article\n      style={{ display: 'flex', flexDirection: 'column', height: '100%' }}\n    >\n      <HeaderMenu left={left} />\n      {showSpinner ? (\n        <Spinner size=\"xxlarge\" middle />\n      ) : (\n        <MutatedForm note={note} autoSave={couchNote ? true : false} />\n      )}\n    </article>\n  )\n}\n\nexport default ({ match }) => {\n  const id = match.params.id\n  const query = client => client.find(doctype).where({ _id: id })\n  const Component = queryConnect({\n    notes: { query, as: 'notes' }\n  })(withRouter(FormOrSpinner))\n  return <Component id={id} />\n}\n"],"sourceRoot":""}